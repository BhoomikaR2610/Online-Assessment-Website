<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Assessment</title>

<style>
body {
    font-family: "Segoe UI", Tahoma, sans-serif;
    margin: 0;
    background: linear-gradient(135deg, #e3f2fd, #f7f8e9);
}

h2 {
    text-align: center;
    margin-top: 20px;
    color: #2e7d32;
}

.timer {
    position: fixed;
    top: 20px;
    right: 20px;
    background: white;
    padding: 10px 18px;
    border-radius: 30px;
    font-weight: bold;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.webcam {
    position: fixed;
    top: 80px;
    right: 20px;
    width: 220px;
    height: 160px;
    border-radius: 14px;
    border: 3px solid #4caf50;
    object-fit: cover;
}

form {
    max-width: 800px;
    margin: 90px auto 40px;
    background: white;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
}

/* QUESTION NAV */
.nav-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
    gap: 10px;
    margin-bottom: 25px;
}

.nav-btn {
    padding: 10px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    background: #e0e0e0;
    font-weight: bold;
    transition: 0.3s;
}

.nav-btn.active {
    background: #1976d2;
    color: white;
}

.nav-btn.answered {
    background: #4caf50;
    color: white;
}

/* QUESTIONS */
.question {
    display: none;
}

.question.active {
    display: block;
}

.options label {
    display: block;
    background: #f7f7f7;
    padding: 12px;
    border-radius: 10px;
    margin-bottom: 10px;
    cursor: pointer;
}

/* CONTROLS */
.controlbtn {
    display: flex;
    justify-content: space-between;
    margin-top: 25px;
}

.controlbtn button {
    padding: 12px 28px;
    border-radius: 30px;
    border: none;
    background: #43a047;
    color: white;
    cursor: pointer;
}

#manualSubmit {
    margin-top: 30px;
    width: 100%;
    padding: 14px;
    font-size: 18px;
    border-radius: 40px;
    border: none;
    background: #2e7d32;
    color: white;
    cursor: pointer;
}
</style>
</head>

<body>

<h2>Assessment</h2>
<div class="timer" id="timer">05:00</div>

<video id="webcam" class="webcam" autoplay muted></video>
<p id="camStatus" style="text-align:right;color:red;margin-right:30px;"></p>

<form id="quizForm" method="POST" action="{{ url_for('assessment') }}">

<!-- QUESTION NAVIGATION -->
<div class="nav-grid" id="navGrid">
{% for q in questions %}
    <button type="button" class="nav-btn" data-index="{{ loop.index0 }}">
        {{ loop.index }}
    </button>
{% endfor %}
</div>

{% for q in questions %}
<div class="question" id="question-{{ loop.index0 }}">
    <p><strong>{{ loop.index }}. {{ q.question }}</strong></p>

    {% for opt in q.options %}
    <label>
        <input type="radio" name="{{ q.id }}" value="{{ opt }}"
        {% if answers and q.id in answers and answers[q.id] == opt %} checked {% endif %}>
        {{ opt }}
    </label>
    {% endfor %}
</div>
{% endfor %}

<div class="controlbtn">
    <button type="button" id="prev">Previous</button>
    <button type="button" id="next">Next</button>
</div>

<button type="button" id="manualSubmit">Submit Assessment</button>
</form>

<script>
document.addEventListener("DOMContentLoaded", () => {

const questions = document.querySelectorAll(".question");
const navBtns = document.querySelectorAll(".nav-btn");
let currentIndex = 0;

function showQuestion(i) {
    questions.forEach(q => q.classList.remove("active"));
    navBtns.forEach(b => b.classList.remove("active"));
    questions[i].classList.add("active");
    navBtns[i].classList.add("active");
    currentIndex = i;
}

showQuestion(0);

/* NAV BUTTON CLICK */
navBtns.forEach(btn => {
    btn.onclick = () => showQuestion(parseInt(btn.dataset.index));
});

/* ANSWER TRACK */
document.querySelectorAll("input[type=radio]").forEach(input => {
    input.onchange = () => {
        navBtns[currentIndex].classList.add("answered");
    };
});

/* NEXT / PREV */
document.getElementById("next").onclick = () => {
    if (currentIndex < questions.length - 1) showQuestion(currentIndex + 1);
};
document.getElementById("prev").onclick = () => {
    if (currentIndex > 0) showQuestion(currentIndex - 1);
};

/* TIMER */
let totalTime = 300;
const timer = document.getElementById("timer");

const interval = setInterval(() => {
    let m = Math.floor(totalTime / 60);
    let s = totalTime % 60;
    timer.textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    if (totalTime === 0) submitForm();
    totalTime--;
}, 1000);

/* SUBMIT */
function submitForm() {
    stopWebcam();
    fetch(quizForm.action, { method: "POST", body: new FormData(quizForm) })
        .then(() => window.location.href = "{{ url_for('result') }}");
}

document.getElementById("manualSubmit").onclick = () => {
    if (confirm("Submit assessment now?")) {
        clearInterval(interval);
        submitForm();
    }
};

/* WEBCAM SAFE */
let stream = null;
const video = document.getElementById("webcam");

navigator.mediaDevices.getUserMedia({ video: true })
.then(s => {
    stream = s;
    video.srcObject = stream;
})
.catch(() => {
    document.getElementById("camStatus").innerText =
        "Camera not available. Exam continues.";
    video.style.display = "none";
});

function stopWebcam() {
    if (stream) stream.getTracks().forEach(t => t.stop());
}

});
</script>

</body>
</html>
